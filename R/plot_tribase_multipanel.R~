library('ggplot2')
library('reshape2')
library(Rmisc)
library(topicmodels)
library(data.table)

normalizeColumns<-function(table){ 
  for(icol in 1:dim(table)[[2]]){
    sum <- sum(table[,icol])
    for(irow in 1:96){
      print(sprintf('%d %d', icol, irow))
      table[irow,icol] <- table[irow,icol]/sum
    } 
  }
  print(table)
  return(table)
}

plot_tribase_multipanel <- function(matrix_snvs, type, file_name = "test.png", signame = "Unknown", error.up = rep(0,96), error.down = rep(0, 96)){
  typeref<-c(rep('C',48), rep('T',48))
  typealt<-c(rep('A',16), rep('G',16), rep('T',16), rep('A',16), rep('C',16),rep('G',16))
  subtype<-c(rep(c('ACA','ACC','ACG','ACT','CCA','CCC','CCG','CCT','GCA','GCC','GCG','GCT','TCA','TCC','TCG','TCT'),3),rep(c('ATA','ATC','ATG','ATT','CTA','CTC','CTG','CTT','GTA','GTC','GTG','GTT','TTA','TTC','TTG','TTT'),3))
  typerefrev<-c(rep('G',48),rep('A',48))
  typealtrev<-c(rep('T',16),rep('C',16),rep('A',16),rep('T',16),rep('G',16),rep('C',16))
  subtyperev<-c(rep(c('TGT','GGT','CGT','AGT','TGG','GGG','CGG','AGG','TGA','GGC','CGC','AGC','TGA','GGA','CGA','AGA'),3),rep(c('TAT','GAT','CAT','AAT','TAG','GAG','CAG','AAG','TAC','GAC','CAC','AAT','TAA','GAA','CAA','AAA'),3))


  snvs<-rep('',96) 
  context_snvs<-rep('',96)
  for(i in 1:96){
    snvs[[i]]<-paste0(typeref[[i]],">",typealt[[i]])
    context_snvs[[i]] <- paste0(snvs[[i]],":",subtype[[i]])
  }

  colnames(matrix_snvs) <- type
  matrix_snvs$context <- context_snvs
  matrix_snvs$snvs <- snvs
  matrix_snvs$subtype <- subtype
  matrix_snvs$error.up <- error.up
  matrix_snvs$error.down <- error.down
    
  
  molten_table <- melt(matrix_snvs, id = c('context', 'snvs', 'subtype', 'error.up', 'error.down'))
 
  c_snv_palette <- c("deepskyblue", "black", "firebrick2", "grey","chartreuse3","pink2")
  c_snv_pal_label <- c(rep("deepskyblue",16), rep("black",16), rep("firebrick2",16), rep("grey",16), rep("chartreuse3",16), rep("pink2",16))

#replace median by value
  plot <- ggplot(molten_table, aes(x = context, y =  value, fill = snvs))
  plot <- plot + theme_minimal() + theme(axis.text.x=element_text(angle=90,hjust=1,size = 6), axis.text.y = element_text(size = 12))
  plot <- plot + geom_bar(position=position_dodge(), stat="identity") 
  plot <- plot +  scale_fill_manual(name = "sig_group", values = c_snv_palette)
  plot <- plot + theme(axis.text.x = element_text(colour = c_snv_pal_label))
  plot <- plot + theme(axis.title.y = element_text(size = 20), axis.title.x = element_text(size = 20), text = element_text(size = 12))
  plot <- plot + scale_x_discrete(labels = subtype)
  plot <- plot + ylab("Weights") + xlab("") 
  plot <- plot + theme(legend.title = element_blank(),legend.justification = c(1,1))
  plot <- plot + theme(legend.text = element_text(size = 18, face = "bold"))
  plot <- plot + theme(legend.position="top")
  plot <- plot + theme(legend.direction = "horizontal")
  plot <- plot + geom_text(aes(x=-Inf,y=Inf,hjust=0,vjust=1,label=signame), size = 20)
  plot <- plot + geom_errorbar(aes(ymin = error.down, ymax = error.up), width = 0)
  plot <- plot + facet_wrap(~variable, nrow = 3, scales = "free")
  ggsave(plot, filename = file_name, width = 18, height = 8, dpi = 120) #20
}
