#' Generates summary plot 
#'
#' @param file the csv file produced by SigMA

plot_summary <- function(file = NULL){
  df <- read.csv(file)
  str(df)
  # read SigMA settings from file name
  msk_string <- gsub(platform_names[['msk']],
                     pattern = ' ', replace = '')

  exome_string <- gsub(platform_names[['seqcap']],
                     pattern = ' ', replace = '')

  wgs_string <- gsub(platform_names[['wgs']],
                     pattern = ' ', replace = '')

  tumor_type <- unlist(strsplit(unlist(strsplit(file, 
                                                split = 'tumortype_'))[[2]],
                       split = '_platform_'))[[1]]

  platform <- unlist(strsplit(unlist(strsplit(file, 
                                              split = 'platform_'))[[2]],
                     split = '.csv'))[[1]]


  if(platform == msk_string) data = 'msk'
  if(platform == exome_string) data = 'seqcap'
  if(platform == wgs_string) data = 'wgs'

  if(data == 'msk'){
    cutoff_strict <- cutoffs_msk_strict[[tumor_type]]
    cutoff <- cutoffs_msk[[tumor_type]]
  }else if(data == 'seqcap'){
    cutoff_strict <- cutoffs_exome_strict[[tumor_type]]
    cutoff <- cutoffs_exome[[tumor_type]]
  }else if(data == 'wgs'){
    cutoff_strict <- cutoffs_wgs_strict[[tumor_type]]
    cutoff <- cutoffs_wgs[[tumor_type]]
  }

  text_size = 10


  # 3-base distributions
  if(sum(df$pass_mva) > 0){ 
    inds_pos <- which(df$pass_mva)
    pos_tribase <- plot_tribase_dist(as.data.frame(colSums(df[inds_pos, 1:96])),
                                     signame = paste0('  Aggregated mutations from ', 
                                                      sum(df$pass_mva), ' Sig3+ sample(s)'))
  }
  if(sum(!df$pass_mva) > 0){
    inds_neg <- which(!df$pass_mva)
    neg_tribase <- plot_tribase_dist(as.data.frame(colSums(df[inds_neg, 1:96])),
                                     signame = paste0('  Aggregated mutations from ', 
                                                      sum(df$pass_mva == F), ' Sig3- sample(s)'))
  }

  neg_tribase <- neg_tribase + ggplot2::theme(legend.position = "none")

  # cosine density distribution
  colors_cos <- col_pos_neg
  if(length(unique(df$pass_mva)) == 1){
    if(unique(df$pass_mva))
      colors_cos <- col_pos_neg[[2]]
    else
      colors_cos <- col_pos_neg[[1]]
  }

  plot_cos <- ggplot2::ggplot(df, ggplot2::aes(x = Signature_3_c))
  plot_cos <- plot_cos + ggplot2::geom_density(ggplot2::aes(color = pass_mva))
  plot_cos <- plot_cos + ggplot2::scale_color_manual(values = colors_cos)
  plot_cos <- plot_cos + theme_def + ggplot2::theme(axis.title.x = ggplot2::element_text(size = text_size),
                                                    axis.title.y = ggplot2::element_text(size = text_size),
                                                    axis.text.x = ggplot2::element_text(size = text_size),
                                                    axis.text.y = ggplot2::element_text(size = text_size))

  plot_cos <- plot_cos + ggplot2::xlab('Cosine similarity of Sig3')
  plot_cos <- plot_cos + ggplot2::xlim(0, 1)


  # likelihood density distribution
  inds <- grep('_ml', colnames(df))
  ind_tumor <- grep('tumor', colnames(df))
  inds <- c(inds, ind_tumor)
  rm(ind_tumor)

  df_ml <- df[, inds]
  df_ml <- df_ml[, grep('Signature_3', colnames(df_ml))]
  df_ml$Signature_3_ml <- rowSums(df_ml)
  df_ml$tumor <- as.character(df$tumor)
  df_ml$pass_mva <- df$pass_mva
  df_ml$Signature_3_mva <- df$Signature_3_mva 

  plot_ml <- ggplot2::ggplot(df_ml, ggplot2::aes(x = Signature_3_ml))
  plot_ml <- plot_ml + ggplot2::geom_density(ggplot2::aes(color = pass_mva))
  plot_ml <- plot_ml + ggplot2::scale_color_manual(values = colors_cos) 
  # here add a line to strip away the legend
  plot_ml <- plot_ml + theme_def + ggplot2::theme(axis.title.x = ggplot2::element_text(size = text_size),
                                                  axis.title.y = ggplot2::element_text(size = text_size),
                                                  axis.text.x = ggplot2::element_text(size = text_size),
                                                  axis.text.y = ggplot2::element_text(size = text_size))


  plot_ml <- plot_ml + ggplot2::xlab('Likelihood of Sig3')
  plot_ml <- plot_ml + ggplot2::xlim(0, 1)  

  # score bar plot
  df_ml$Signature_3_mva <- df_ml$Signature_3_mva 
  df_ml$group <- 'Sig3 -'
  df_ml$group[df_ml$Signature_3_mva > cutoff] <- 'lc Sig3 +'
  df_ml$group[df_ml$Signature_3_mva > cutoff_strict] <- 'Sig3 +'

  df_color <- data.frame(color = c(col_pos_neg[[1]], "#dee9fc", col_pos_neg[[2]]),
                         group = c('Sig3 -', 'lc Sig3 +', 'Sig3 +'))
  size_nchar <- mean(unlist(apply(df_ml, 1, function(x){ nchar(x['tumor']) })))
  df_ml$tumor_label <- df_ml$tumor
  if(size_nchar > 20){
    df_ml$tumor_label <- paste0('tumor', 1:dim(df_ml)[[1]])
  }
  df_ml$group_fac <- df_ml$group
  df_ml <- transform(df_ml, group_fac = factor(group_fac, 
                                               levels = unique(df_ml$group)))


  plot_score <- ggplot2::ggplot(df_ml, 
                                ggplot2::aes(x = tumor_label, 
                                             y = Signature_3_mva))
  plot_score <- plot_score + ggplot2::geom_bar(ggplot2::aes(fill = group_fac),
                                               stat = 'identity')
  plot_score <- plot_score + ggplot2::scale_fill_manual(values = as.character(df_color$color[match(unique(df_ml$group), 
                                                                                             df_color$group)]))
  plot_score <- plot_score + theme_def 
  plot_score <- plot_score + ggplot2::theme(panel.border = ggplot2::element_blank(),
                                            axis.line.y = ggplot2::element_line(size = 0.3, 
                                                                                linetype = "solid", 
                                                                                colour = "black"),
                                            axis.line.x = ggplot2::element_line(size = 0.3, 
                                                                                linetype = "solid", 
                                                                                colour = "black"),
                                            axis.text.x = ggplot2::element_text(size = text_size,
                                                                                hjust = 1,
                                                                                angle = 45), 
                                            axis.title.y = ggplot2::element_text(size = text_size),
                                            axis.text.y = ggplot2::element_text(size = text_size),
                                            legend.position = 'top')
  plot_score <- plot_score + ggplot2::ylab('MVA score') + ggplot2::xlab('')
  plot_score <- plot_score + ggplot2::geom_hline(ggplot2::aes(yintercept = cutoff))
  plot_score <- plot_score + ggplot2::geom_hline(ggplot2::aes(yintercept = cutoff_strict), 
                                                 linetype = 'dashed')

  # Signature 3 exposures 
  plot_exp <- ggplot2::ggplot(df[df$exp_sig3 > 0,], ggplot2::aes(x = exp_sig3))
  plot_exp <- plot_exp + ggplot2::geom_density(ggplot2::aes(color = pass_mva))

  colors_exp <- col_pos_neg
  if(length(unique(df$pass_mva[df$exp_sig3 > 0])) == 1){
    if(unique(df$pass_mva[df$exp_sig3 > 0]))
      colors_exp <- col_pos_neg[[2]]
    else 
      colors_exp <- col_pos_neg[[1]]
  }

  plot_exp <- plot_exp + ggplot2::scale_color_manual(values = colors_exp)
  plot_exp <- plot_exp + theme_def + ggplot2::theme(axis.title.x = ggplot2::element_text(size = text_size),
                                                    axis.title.y = ggplot2::element_text(size = text_size),
                                                    axis.text.x = ggplot2::element_text(size = text_size),
                                                    axis.text.y = ggplot2::element_text(size = text_size))
  plot_exp <- plot_exp + ggplot2::xlab('Sig3 exposure')
  plot_exp <- plot_exp + ggplot2::xlim(0, max(df$exp_sig3))

  # combined plot

  pdf('summary_short_sig3.pdf', width = 1.2*9.8/2.4, 7)
  if(sum(df$pass_mva) > 0 & sum(!df$pass_mva > 0)){
    lay <- rbind(c(6, 6, 6),
                 c(3, 4, 5),
                 c(1, 1, 1),
                 c(2, 2, 2))
    plot_arr <- gridExtra::grid.arrange(pos_tribase,
                                   neg_tribase,
                                   plot_cos,
                                   plot_ml,
                                   plot_exp,
                                   plot_score,
                                   layout_matrix = lay, 
                                   heights = c(1.5, 0.8, 1.1, 0.85))
  }else if(sum(df$pass_mva) > 0 & sum(!df$pass_mva == 0)){
    lay <- rbind(c(5, 5, 5),
                 c(2, 3, 4),
                 c(1, 1, 1))
    plot_arr <- gridExtra::grid.arrange(pos_tribase,
                                   plot_cos,
                                   plot_ml,
                                   plot_exp,
                                   plot_score,
                                   layout_matrix = lay, 
                                   heights = c(1.5, 0.8, 1.1, 0.85))
  }else if(sum(df$pass_mva) == 0 & sum(!df$pass_mva > 0)){
    lay <- rbind(c(5, 5, 5),
                 c(2, 3, 4),
                 c(1, 1, 1))
    plot_arr <- gridExtra::grid.arrange(neg_tribase,
                                   plot_cos,
                                   plot_ml,
                                   plot_exp,
                                   plot_score,
                                   layout_matrix = lay, 
                                   heights = c(1.5, 0.8, 1.1, 0.85))
  }

  dev.off()                      
  return(plot_arr)
}