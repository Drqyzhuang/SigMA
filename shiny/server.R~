library('DT')
library(shinycssloaders)

myplot <- function(x) {
  plot <- gridExtra::arrangeGrob(x)
  class(plot) <- c("myplot", class(plot))
  plot
}

print.myplot <- function(x, ...) {
  grid::grid.draw(x)
}

server <- function(input, output, session){

  file_memory <- reactiveValues(
    name = '')

  # run SigMA
  output_file <- eventReactive(input$do_run,{
    if(recalculate$val){
      genomes_matrix <- make_matrix(directory = input$directory, 
                                    file_type = input$file_type)
      genomes <- conv_snv_matrix_to_df(genomes_matrix)
      genomes_file = 'example.csv'
      write.table(genomes,
              genomes_file,
              sep = ',',
              row.names = F,
              col.names = T ,
              quote = F)
      ind <- which(as.character(tissue_names) == input$tumor_type)
      tumor_type = names(tissue_names)[[ind]]
    
      ind <- which(as.character(platform_names) == input$data)
      data = names(platform_names)[[ind]]
    
      output_file <- run(genomes_file, 
                         tumor_type = tumor_type,
                         data = data,
                         do_mva = T,
                         do_assign = T)
      print('Finished running SigMA')
      file_memory$name <<- output_file
      return(output_file)
    }else{
      return(file_memory$name)
    }
  })


  recalculate <- reactiveValues(val = T)

  # make summary figure
  plot <- reactive({
    return(myplot(plot_summary(output_file())))
  })
  
  output$plot2 <- renderPlot({
    print(plot())
  })

  
  # make a data table 
  sorted_samples <- reactive({
    df <- read.csv(output_file())
    df <- df[order(-df$Signature_3_mva),]
    df$name <- paste0('tumor', 1:dim(df)[[1]])
    df$Signature_3_mva <- round(df$Signature_3_mva, digit = 4)
    df2 <- df[, c('name', 'tumor', 'Signature_3_mva')]
    colnames(df2) <- c('tag', 'filename', 'score')

    buttons <- character(dim(df2)[[1]])
    
    for(i in 1:dim(df2)[[1]]){
      buttons[[i]] <- as.character(actionButton(
                                     df2$tag[[i]], 
                                     label = df2$tag[[i]], 
                                     onclick = 'Shiny.onInputChange(\"select_button\", this.id)'))
                  
                                                  
    }
    df2$tagname <- df2$tag
    df2$tag <- buttons
    return(df2)
  })

  output$sorted_samples <- renderDataTable(
                             datatable(sorted_samples()[, -which(colnames(sorted_samples()) == "tagname")], 
                                       escape = F, 
                                       rownames = F,
                                       options = list(dom = 'ftr', scrollY = T)) %>%
                             formatStyle(c("tag", "filename", "score"),
                                         backgroundColor = '#eaf1fc'))
                                     
                                         

  # add buttons in the data table so that                                       

  this_sample <- reactiveValues(sample = '')

  observeEvent(input$select_button, {
    selectedRow <- as.integer(c(unlist(strsplit(input$select_button, split = "tumor")))[[2]])
    this_sample$sample <<- sorted_samples()$filename[[selectedRow]]
  })


  plotd <- reactive({
    if(this_sample$sample != '')
      myplot(plot_detailed(output_file(), this_sample$sample))
  })

  output$plotd2 <- renderPlot({
    if(this_sample$sample != '')
      print(plotd())
  })


  dataset <- reactiveValues(number = 0)

  observeEvent(input$do_run, {
    # cleaning tabs

    recalculate$val <<- T
    output_file()    
    recalculate$val <<- F

    removeTab(inputId = "tabs", target = paste0("Results ", dataset$number))
    dataset$number <<- dataset$number + 1
    removeTab(inputId = "tabs", target = "Details")   

    insertTab(inputId = "tabs",
      tabPanel(
        paste0("Results ", dataset$number),
        fluidRow(style = "padding:15px;
                             margin-left:15px;
                             margin-right:15px;
                             margin-top:15px;
                             margin-bottom:15px;",
             
          column(7, style = "background-color: #eaf1fc",
            h4("Click to see sample-specific information"),
            dataTableOutput("sorted_samples") %>% withSpinner(color="#dee9fc")
          ),
          column(5, h4("Summary") ,
            plotOutput("plot2", width = "90%", height = "750px") %>% withSpinner(color="#dee9fc")
          )
        )
      ),
      target = "Info"
    )
  })

  observeEvent(input$do_run, {
    updateTabsetPanel(session, "tabs", selected = paste0("Results ", dataset$number))
  })

  observeEvent(input$select_button, {
    removeTab(inputId = "tabs", target = "Details")

    insertTab(inputId = "tabs",
      tabPanel(
        "Details",
        fluidRow(style = "padding:15px;
                             margin-left:15px;
                             margin-right:15px;
                             margin-top:15px;
                             margin-bottom:15px;",
          column(6, 
            fluidRow(
              plotOutput("plotd2", width = "90%", height = "400px") %>% withSpinner(color="#dee9fc")
            )
          )
        )
      ),
      target = "Info"
    )
  })

  observeEvent(input$select_button, {
    updateTabsetPanel(session, "tabs", 
      selected = "Details")
  })

}